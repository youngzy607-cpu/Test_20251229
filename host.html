<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿ä¸»æ§åˆ¶å° - Kelly Pool</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="lib/mqtt.min.js"></script>
    <script src="lib/qrcode.min.js"></script>
    <script src="js/mqtt-client.js"></script>
    <script src="js/game-logic.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h3>æˆ¿ä¸»æ§åˆ¶å° | æˆ¿é—´: <span id="room-display">...</span></h3>
            <div id="mqtt-status" style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                MQTT: <span id="status-text">è¿æ¥ä¸­...</span>
            </div>
        </div>

        <!-- é˜¶æ®µ1: ç­‰å¾…ç©å®¶ -->
        <div id="setup-phase">
            <div style="text-align: center; margin-bottom: 20px;">
                <div id="qrcode" style="display: inline-block; padding: 10px; background: white; border-radius: 8px;"></div>
                <p style="font-size: 0.8rem; color: #aaa; margin-top: 5px;">æ‰«ç æˆ–å¤åˆ¶é“¾æ¥åŠ å…¥</p>
                <input type="text" id="share-link" readonly style="font-size: 0.8rem; padding: 5px; width: 80%; background: #222; border: 1px solid #444; color: #aaa;" onclick="this.select()">
            </div>

            <h4>å·²åŠ å…¥ç©å®¶ (<span id="player-count">0</span>)</h4>
            <ul id="player-list" class="player-list">
                <!-- <li>Player 1 <span class="status-badge online">åœ¨çº¿</span></li> -->
            </ul>
            
            <div id="host-logs" style="height: 100px; overflow-y: auto; background: #222; font-size: 0.7rem; color: #888; padding: 5px; margin: 10px 0; border-radius: 4px;">
                <div>æ—¥å¿—ç³»ç»Ÿå°±ç»ª...</div>
            </div>

            <div class="input-group">
                <label>æ¯äººå‘ç‰Œæ•° (0=è‡ªåŠ¨å¹³å‡):</label>
                <input type="number" id="card-count" value="0" min="0" max="15">
            </div>
            <button class="btn btn-primary" onclick="startGame()">å¼€å§‹å‘ç‰Œ</button>
        </div>

        <!-- é˜¶æ®µ2: æ¸¸æˆè¿›è¡Œä¸­ -->
        <div id="game-phase" style="display: none;">
            <h4>ç‚¹å‡»ä¸‹æ–¹çƒå·æ ‡è®°ä¸ºâ€œå·²æ‰“è¿›â€</h4>
            <div class="ball-grid" id="ball-grid">
                <!-- ç”Ÿæˆ 1-15 å·çƒ -->
            </div>
            
            <hr style="border-color: #444; margin: 20px 0;">
            
            <button class="btn btn-secondary" onclick="resetGame()">é‡ç½®æ¸¸æˆ (é‡æ–°å‘ç‰Œ)</button>
            
            <h4>ç©å®¶æ‰‹ç‰ŒçŠ¶æ€ç›‘æ§</h4>
            <div id="monitor-area" style="font-size: 0.8rem; color: #aaa;">
                <!-- æˆ¿ä¸»å¯è§æ‰€æœ‰äººçš„æ‰‹ç‰Œï¼Œç”¨äºè£åˆ¤ -->
            </div>
        </div>
    </div>

    <script>
        const roomId = localStorage.getItem('kp_room_id');
        if (!roomId) window.location.href = 'index.html';
        document.getElementById('room-display').innerText = roomId;

        // ç”ŸæˆäºŒç»´ç 
        const joinUrl = window.location.href.replace('host.html', 'index.html') + '?room=' + roomId;
        document.getElementById('share-link').value = joinUrl; // æ˜¾ç¤ºé“¾æ¥æ–¹ä¾¿å¤åˆ¶
        
        new QRCode(document.getElementById("qrcode"), {
            text: joinUrl,
            width: 128,
            height: 128
        });

        const players = {}; // { clientId: { name: 'xxx', hand: [] } }
        let pocketedBalls = new Set();
        
        function log(msg) {
            const logs = document.getElementById('host-logs');
            const div = document.createElement('div');
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        // Topic å®šä¹‰
        const TOPIC_JOIN = `kp/${roomId}/join`;
        const TOPIC_CMD = `kp/${roomId}/cmd`;

        // åˆå§‹åŒ– MQTT
        window.gameClient.connect(() => {
            document.getElementById('status-text').innerText = 'âœ… å·²è¿æ¥';
            document.getElementById('status-text').style.color = '#2ecc71';
            log(`Host subscribing to: ${TOPIC_JOIN}`);
            window.gameClient.subscribe(TOPIC_JOIN);
        });
        
        // ç›‘å¬æ–­çº¿
        if (window.gameClient.client) {
            window.gameClient.client.on('offline', () => {
                document.getElementById('status-text').innerText = 'âŒ å·²æ–­å¼€';
                document.getElementById('status-text').style.color = 'red';
            });
            window.gameClient.client.on('reconnect', () => {
                document.getElementById('status-text').innerText = 'ğŸ”„ é‡è¿ä¸­...';
            });
        }

        // æ¶ˆæ¯å¤„ç†
        window.gameClient.on('JOIN', (payload) => {
            log(`Received JOIN: ${payload.name}`);
            const { sender, name } = payload;
            
            // ç¡®ä¿ä¸æŠŠè‡ªå·±ç®—è¿›å»ï¼ˆè™½ç„¶ host é¡µé¢ä¸å‘ JOINï¼Œä½†ä»¥é˜²ä¸‡ä¸€ï¼‰
            // æ³¨æ„ï¼šsender æ˜¯å‘é€è€…çš„ clientId
            
            if (!players[sender]) {
                players[sender] = { name: name || 'Player ' + sender.substr(0,4), hand: [] };
                updatePlayerList();
                log(`New player added: ${name}`);
            } else {
                log(`Player ${name} reconnected`);
            }
        });

        function updatePlayerList() {
            const list = document.getElementById('player-list');
            document.getElementById('player-count').innerText = Object.keys(players).length;
            list.innerHTML = Object.keys(players).map(pid => 
                `<li class="player-item">
                    ${players[pid].name} 
                    <span class="status-badge online">å·²è¿æ¥</span>
                </li>`
            ).join('');
        }

        // ç”Ÿæˆçƒçš„ UI
        const ballGrid = document.getElementById('ball-grid');
        for (let i = 1; i <= 15; i++) {
            const ball = document.createElement('div');
            ball.className = 'ball';
            ball.dataset.num = i;
            ball.innerText = i;
            ball.onclick = () => toggleBall(i);
            ballGrid.appendChild(ball);
        }

        function toggleBall(num) {
            const ballElem = document.querySelector(`.ball[data-num="${num}"]`);
            
            if (pocketedBalls.has(num)) {
                // æ’¤é”€æ‰“è¿› (æš‚ä¸æ”¯æŒï¼ŒMVP ç®€åŒ–é€»è¾‘ï¼šä¸€æ—¦æ‰“è¿›å°±æ‰“è¿›äº†)
                // pocketedBalls.delete(num);
                // ballElem.classList.remove('pocketed');
                return; 
            } else {
                pocketedBalls.add(num);
                ballElem.classList.add('pocketed');
                
                // å¹¿æ’­çƒå·²æ‰“è¿›
                window.gameClient.publish(TOPIC_CMD, 'BALL_POCKETED', { ball: num });
                
                // æ›´æ–°ç›‘æ§è§†å›¾
                updateMonitor();
            }
        }

        function startGame() {
            const playerIds = Object.keys(players);
            if (playerIds.length === 0) return alert('æ²¡æœ‰ç©å®¶åŠ å…¥ï¼');

            const countPerPlayer = parseInt(document.getElementById('card-count').value) || 0;
            
            // è°ƒç”¨é€»è¾‘åº“å‘ç‰Œ
            const hands = window.kellyLogic.deal(playerIds, countPerPlayer);
            
            // ä¿å­˜çŠ¶æ€
            Object.keys(hands).forEach(pid => {
                players[pid].hand = hands[pid];
            });

            // å¹¿æ’­å‘ç‰Œä¿¡æ¯ (ç‚¹å¯¹ç‚¹å‘é€å…¶å®ä¹Ÿæ˜¯å¹¿æ’­ï¼Œå®¢æˆ·ç«¯è‡ªå·±è¿‡æ»¤)
            window.gameClient.publish(TOPIC_CMD, 'DEAL', { hands: hands });

            // åˆ‡æ¢ UI
            document.getElementById('setup-phase').style.display = 'none';
            document.getElementById('game-phase').style.display = 'block';
            pocketedBalls.clear();
            
            // é‡ç½®çƒ UI
            document.querySelectorAll('.ball').forEach(b => b.classList.remove('pocketed'));
            updateMonitor();
        }

        function resetGame() {
            if(confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿæ‰€æœ‰æ‰‹ç‰Œå°†é‡æ´—ã€‚')) {
                document.getElementById('setup-phase').style.display = 'block';
                document.getElementById('game-phase').style.display = 'none';
                
                // å¹¿æ’­é‡ç½®
                window.gameClient.publish(TOPIC_CMD, 'RESET');
            }
        }

        function updateMonitor() {
            const monitor = document.getElementById('monitor-area');
            let html = '';
            Object.keys(players).forEach(pid => {
                const p = players[pid];
                const handHtml = p.hand.map(card => {
                    const isPocketed = pocketedBalls.has(card);
                    return `<span style="color:${isPocketed ? 'red;text-decoration:line-through' : 'white'}">${card}</span>`;
                }).join(', ');
                html += `<div>${p.name}: [${handHtml}]</div>`;
            });
            monitor.innerHTML = html;
        }
    </script>
</body>
</html>