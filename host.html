<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿ä¸»æ§åˆ¶å° - Kelly Pool</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="lib/mqtt.min.js"></script>
    <script src="lib/qrcode.min.js"></script>
    <script src="js/mqtt-client.js"></script>
    <script src="js/game-logic.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h3>æˆ¿ä¸»æ§åˆ¶å° | æˆ¿é—´: <span id="room-display">...</span></h3>
            <div id="mqtt-status" style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                MQTT: <span id="status-text">è¿æ¥ä¸­...</span>
            </div>
        </div>

        <!-- é˜¶æ®µ1: ç­‰å¾…ç©å®¶ -->
        <div id="setup-phase">
            <div style="text-align: center; margin-bottom: 20px;">
                <div id="qrcode" style="display: inline-block; padding: 10px; background: white; border-radius: 8px;"></div>
                <p style="font-size: 0.8rem; color: #e74c3c; margin-top: 5px; font-weight: bold;">
                    âš ï¸ è¯·ä½¿ç”¨æ‰‹æœºç³»ç»Ÿç›¸æœº/æµè§ˆå™¨æ‰«ç <br>
                    (å¾®ä¿¡æ‰«ç å¯èƒ½æ— æ³•ç›´æ¥è·³è½¬)
                </p>
                <input type="text" id="share-link" readonly style="font-size: 0.8rem; padding: 5px; width: 80%; background: #222; border: 1px solid #444; color: #aaa;" onclick="this.select()">
            </div>

            <h4>
                å·²åŠ å…¥ç©å®¶ (<span id="player-count">0</span>) 
                <button class="btn btn-secondary" style="width: auto; padding: 5px 10px; font-size: 0.8rem; display: inline-block;" onclick="refreshPlayers()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            </h4>
            <ul id="player-list" class="player-list">
                <!-- <li>Player 1 <span class="status-badge online">åœ¨çº¿</span></li> -->
            </ul>
            
            <div id="host-logs" style="height: 100px; overflow-y: auto; background: #222; font-size: 0.7rem; color: #888; padding: 5px; margin: 10px 0; border-radius: 4px;">
                <div>æ—¥å¿—ç³»ç»Ÿå°±ç»ª...</div>
            </div>

            <div class="input-group">
                <label>æ¯äººå‘ç‰Œæ•° (0=è‡ªåŠ¨å¹³å‡):</label>
                <input type="number" id="card-count" value="0" min="0" max="15">
            </div>
            <button class="btn btn-primary" onclick="startGame()">å¼€å§‹å‘ç‰Œ</button>
        </div>

        <!-- é˜¶æ®µ2: æ¸¸æˆè¿›è¡Œä¸­ -->
        <div id="game-phase" style="display: none;">
            <h4>æˆ‘çš„æ‰‹ç‰Œ</h4>
            <div class="hand-container" id="host-hand-container">
                <!-- æˆ¿ä¸»æ‰‹ç‰Œæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>

            <hr style="border-color: #444; margin: 20px 0;">

            <h4>ç‚¹å‡»ä¸‹æ–¹æ‰‘å…‹ç‰Œæ ‡è®°ä¸ºâ€œå·²æ‰“å‡ºâ€</h4>
            <div class="ball-grid" id="ball-grid" style="grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 5px;">
                <!-- ç”Ÿæˆæ‰‘å…‹ç‰Œ -->
            </div>
            
            <hr style="border-color: #444; margin: 20px 0;">
            
            <button class="btn btn-secondary" onclick="resetGame()">é‡ç½®æ¸¸æˆ (é‡æ–°å‘ç‰Œ)</button>
            
            <h4>ç©å®¶è¿æ¥çŠ¶æ€</h4>
            <div id="monitor-area" style="font-size: 0.8rem; color: #aaa;">
                <!-- æˆ¿ä¸»ä¸å¯è§æ‰‹ç‰Œï¼Œåªæ˜¾ç¤ºè¿æ¥çŠ¶æ€ -->
            </div>
        </div>
    </div>

    <script>
        const roomId = localStorage.getItem('kp_room_id');
        if (!roomId) window.location.href = 'index.html';
        document.getElementById('room-display').innerText = roomId;

        // ç”ŸæˆäºŒç»´ç 
        const joinUrl = window.location.href.replace('host.html', 'index.html') + '?room=' + roomId;
        document.getElementById('share-link').value = joinUrl; // æ˜¾ç¤ºé“¾æ¥æ–¹ä¾¿å¤åˆ¶
        
        new QRCode(document.getElementById("qrcode"), {
            text: joinUrl,
            width: 128,
            height: 128
        });

        const players = {}; // { clientId: { name: 'xxx', hand: [] } }
        let pocketedBalls = new Set();
        
        function log(msg) {
            const logs = document.getElementById('host-logs');
            const div = document.createElement('div');
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        // Topic å®šä¹‰
        const TOPIC_JOIN = `kp/${roomId}/join`;
        const TOPIC_CMD = `kp/${roomId}/cmd`;

        // åˆå§‹åŒ– MQTT
        window.gameClient.connect(() => {
            document.getElementById('status-text').innerText = 'âœ… å·²è¿æ¥';
            document.getElementById('status-text').style.color = '#2ecc71';
            log(`Host subscribing to: ${TOPIC_JOIN}`);
            window.gameClient.subscribe(TOPIC_JOIN);
        });
        
        // ç›‘å¬æ–­çº¿
        if (window.gameClient.client) {
            window.gameClient.client.on('offline', () => {
                document.getElementById('status-text').innerText = 'âŒ å·²æ–­å¼€';
                document.getElementById('status-text').style.color = 'red';
            });
            window.gameClient.client.on('reconnect', () => {
                document.getElementById('status-text').innerText = 'ğŸ”„ é‡è¿ä¸­...';
            });
        }

        function refreshPlayers() {
            log('Requesting status from all players...');
            // è¯·æ±‚æ‰€æœ‰äººä¸ŠæŠ¥çŠ¶æ€
            window.gameClient.publish(TOPIC_CMD, 'REPORT_STATUS', {});
        }

        // æ¶ˆæ¯å¤„ç†
        window.gameClient.on('JOIN', (payload) => {
            handleJoin(payload);
        });
        
        // ç›‘å¬ REPORT_ACK (ç©å®¶å“åº”åˆ·æ–°)
        window.gameClient.on('REPORT_ACK', (payload) => {
            handleJoin(payload); // é€»è¾‘ä¸€æ ·ï¼Œéƒ½æ˜¯æ·»åŠ ç©å®¶
        });

        function handleJoin(payload) {
            log(`Received JOIN/ACK: ${payload.name}`);
            const { sender, name } = payload;
            
            if (!players[sender]) {
                players[sender] = { name: name || 'Player ' + sender.substr(0,4), hand: [] };
                updatePlayerList();
                log(`New player added: ${name}`);
            } else {
                // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´ç­‰
            }
        }

        function updatePlayerList() {
            const list = document.getElementById('player-list');
            document.getElementById('player-count').innerText = Object.keys(players).length;
            list.innerHTML = Object.keys(players).map(pid => 
                `<li class="player-item">
                    ${players[pid].name} 
                    <span class="status-badge online">å·²è¿æ¥</span>
                </li>`
            ).join('');
        }

        // ç”Ÿæˆæ‰‘å…‹ç‰Œ UI
        const ballGrid = document.getElementById('ball-grid');
        const allCards = window.kellyLogic.cards; // ä½¿ç”¨é€»è¾‘åº“ä¸­çš„ç‰Œ
        
        allCards.forEach(card => {
            const ball = document.createElement('div');
            ball.className = 'ball card-item'; // å¤ç”¨ ball æ ·å¼ä½†å¢åŠ  card-item
            ball.dataset.id = card.id;
            
            // æ˜¾ç¤ºå†…å®¹
            let display = card.value;
            let color = 'black';
            if (['H', 'D'].includes(card.suit)) color = '#e74c3c'; // Red
            if (['S', 'C'].includes(card.suit)) color = 'black';
            if (card.suit === 'J') color = card.value === 'Big' ? '#e74c3c' : 'black';
            
            let suitIcon = '';
            if (card.suit === 'S') suitIcon = 'â™ ';
            if (card.suit === 'H') suitIcon = 'â™¥';
            if (card.suit === 'C') suitIcon = 'â™£';
            if (card.suit === 'D') suitIcon = 'â™¦';
            if (card.suit === 'J') suitIcon = 'ğŸƒ';
            
            ball.innerHTML = `<span style="color:${color}">${suitIcon}${display}</span>`;
            ball.onclick = () => toggleBall(card.id);
            ballGrid.appendChild(ball);
        });

        function toggleBall(id) {
            const ballElem = document.querySelector(`.ball[data-id="${id}"]`);
            
            if (pocketedBalls.has(id)) {
                // æ’¤é”€æ‰“è¿› (æš‚ä¸æ”¯æŒï¼ŒMVP ç®€åŒ–é€»è¾‘ï¼šä¸€æ—¦æ‰“è¿›å°±æ‰“è¿›äº†)
                return; 
            } else {
                pocketedBalls.add(id);
                ballElem.classList.add('pocketed');
                
                // è·å–å¡ç‰Œå€¼
                let cardValue = null;
                const cardObj = window.kellyLogic.cards.find(c => c.id === id);
                if (cardObj) cardValue = cardObj.value;

                // å¹¿æ’­çƒå·²æ‰“è¿›ï¼Œå¸¦ä¸Š value
                window.gameClient.publish(TOPIC_CMD, 'BALL_POCKETED', { ball: id, value: cardValue });
                
                // æ›´æ–°ç›‘æ§è§†å›¾
                updateMonitor();
            }
        }

        function startGame() {
            // æˆ¿ä¸»ä¹Ÿä½œä¸ºç©å®¶å‚ä¸ï¼Œéœ€è¦å…ˆç¡®ä¿æˆ¿ä¸»åœ¨ players åˆ—è¡¨ä¸­
            // ä½¿ç”¨ç‰¹æ®Šçš„ HOST ID
            const hostId = 'HOST_PLAYER';
            if (!players[hostId]) {
                players[hostId] = { name: 'æˆ¿ä¸» (æˆ‘)', hand: [] };
            }

            const playerIds = Object.keys(players);
            // playerIds å·²ç»åŒ…å«äº† HOST_PLAYER
            if (playerIds.length === 0) return alert('æ²¡æœ‰ç©å®¶åŠ å…¥ï¼');
            
            // é»˜è®¤æ¯äººå‘ç‰Œæ•°è°ƒæ•´ï¼šå¦‚æœæœªè®¾ç½®ï¼Œå°è¯•å‘å®Œæ‰€æœ‰ç‰Œ
            // 54å¼ ç‰Œï¼Œå¦‚æœæ˜¯4äººï¼Œæ¯äºº13å¼ ï¼Œä½™2å¼ ã€‚
            // é€»è¾‘åº“å·²ç»å¤„ç†äº†å¹³å‡åˆ†å‘
            const countPerPlayer = parseInt(document.getElementById('card-count').value) || 0;
            
            // è°ƒç”¨é€»è¾‘åº“å‘ç‰Œ
            const hands = window.kellyLogic.deal(playerIds, countPerPlayer);
            
            // ä¿å­˜çŠ¶æ€
            Object.keys(hands).forEach(pid => {
                players[pid].hand = hands[pid];
            });

            // æˆ¿ä¸»æ¸²æŸ“è‡ªå·±çš„æ‰‹ç‰Œ
            renderHostHand(players[hostId].hand);

            // å¹¿æ’­å‘ç‰Œä¿¡æ¯ (ç‚¹å¯¹ç‚¹å‘é€å…¶å®ä¹Ÿæ˜¯å¹¿æ’­ï¼Œå®¢æˆ·ç«¯è‡ªå·±è¿‡æ»¤)
            window.gameClient.publish(TOPIC_CMD, 'DEAL', { hands: hands });

            // åˆ‡æ¢ UI
            document.getElementById('setup-phase').style.display = 'none';
            document.getElementById('game-phase').style.display = 'block';
            pocketedBalls.clear();
            
            // é‡ç½®çƒ UI
            document.querySelectorAll('.ball').forEach(b => b.classList.remove('pocketed'));
            updateMonitor();
        }

        function resetGame() {
            if(confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿæ‰€æœ‰æ‰‹ç‰Œå°†é‡æ´—ã€‚')) {
                document.getElementById('setup-phase').style.display = 'block';
                document.getElementById('game-phase').style.display = 'none';
                
                // å¹¿æ’­é‡ç½®
                window.gameClient.publish(TOPIC_CMD, 'RESET');
            }
        }

        function updateMonitor() {
            const monitor = document.getElementById('monitor-area');
            let html = '';
            Object.keys(players).forEach(pid => {
                const p = players[pid];
                // ä»…æ˜¾ç¤ºåå­—å’Œåœ¨çº¿çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºæ‰‹ç‰Œ
                html += `<div>${p.name}: å·²è¿æ¥ (æ‰‹ç‰Œå·²å‘: ${p.hand.length}å¼ )</div>`;
            });
            monitor.innerHTML = html;
        }

        function renderHostHand(hand) {
            const container = document.getElementById('host-hand-container');
            container.innerHTML = hand.map(card => {
                let color = 'black';
                if (['H', 'D'].includes(card.suit)) color = '#e74c3c';
                if (card.suit === 'J' && card.value === 'Big') color = '#e74c3c';
                
                let suitIcon = '';
                if (card.suit === 'S') suitIcon = 'â™ ';
                if (card.suit === 'H') suitIcon = 'â™¥';
                if (card.suit === 'C') suitIcon = 'â™£';
                if (card.suit === 'D') suitIcon = 'â™¦';
                if (card.suit === 'J') suitIcon = 'ğŸƒ';
                
                const isPocketed = pocketedBalls.has(card.id);

                return `
                <div class="hand-card ${isPocketed ? 'pocketed' : ''}" id="host-card-${card.id}" style="color: ${color}">
                    <div style="font-size: 0.8rem;">${suitIcon}</div>
                    <div style="font-size: 1.2rem; font-weight: bold;">${card.value}</div>
                </div>
            `}).join('');
        }

        // ç›‘å¬ BALL_POCKETED æ¥æ›´æ–°æˆ¿ä¸»æ‰‹ç‰Œ UI
        window.gameClient.on('BALL_POCKETED', (payload) => {
             // æˆ¿ä¸»è‡ªå·±ç•Œé¢ä¹Ÿå¾—æ›´æ–°æ‰“å‰çŠ¶æ€
             const { ball, value } = payload;
             
             // é€»è¾‘å‡çº§ï¼šåªè¦ value ç›¸åŒï¼Œå°±éƒ½æ‰“å‰
             // éå†æˆ¿ä¸»æ‰‹ç‰Œï¼Œæ‰¾åˆ°æ‰€æœ‰ value ç›¸åŒçš„ç‰Œ
             const hostHand = players['HOST_PLAYER']?.hand || [];
             hostHand.forEach(card => {
                 if (card.value === value) {
                     const cardElem = document.getElementById(`host-card-${card.id}`);
                     if(cardElem) {
                         cardElem.classList.add('pocketed');
                     }
                 }
             });
        });
    </script>
</body>
</html>