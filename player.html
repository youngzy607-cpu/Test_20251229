<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©å®¶æ‰‹ç‰Œ - Kelly Pool</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="lib/mqtt.min.js"></script>
    <script src="js/mqtt-client.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h3>æˆ¿é—´: <span id="room-id-display"></span> | ç©å®¶: <span id="player-name-display"></span></h3>
             <div id="mqtt-status" style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                MQTT: <span id="status-text">è¿æ¥ä¸­...</span>
            </div>
        </div>

        <div id="join-overlay" style="text-align: center; margin-top: 50px;">
            <input type="text" id="player-name" placeholder="è¾“å…¥ä½ çš„æ˜µç§°">
            <button class="btn btn-primary" onclick="confirmJoin()">ç¡®è®¤åŠ å…¥</button>
        </div>

        <div id="waiting-msg" style="display: none; text-align: center; margin-top: 50px;">
            <div class="loading">ç­‰å¾…æˆ¿ä¸»å‘ç‰Œ...</div>
            <p style="font-size: 0.8rem; color: #888; margin-top: 20px;">
                å¦‚æœæˆ¿ä¸»æ²¡çœ‹åˆ°ä½ ï¼Œè¯·ç‚¹å‡»ï¼š<br>
                <button class="btn btn-secondary" style="width: auto; margin-top: 10px;" onclick="resendJoin()">ğŸ‘‹ æˆ‘åœ¨è¿™é‡Œ (é‡å‘åŠ å…¥)</button>
            </p>
        </div>

        <div id="hand-area" style="display: none;">
            <h2 style="margin-bottom: 30px;">ä½ çš„æ‰‹ç‰Œ</h2>
            <div class="hand-container" id="cards-container">
                <!-- æ‰‹ç‰Œå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
            <p style="text-align: center; color: #666; margin-top: 30px; font-size: 0.8rem;">
                å½“å¯¹åº”çš„çƒè¢«æ‰“è¿›æ—¶ï¼Œæ‰‹ç‰Œä¼šè‡ªåŠ¨æ‰“å‰
            </p>
        </div>
    </div>

    <script>
        const roomId = localStorage.getItem('kp_room_id');
        if (!roomId) window.location.href = 'index.html';
        document.getElementById('room-id-display').innerText = roomId;

        const TOPIC_JOIN = `kp/${roomId}/join`;
        const TOPIC_CMD = `kp/${roomId}/cmd`;
        let myHand = [];

        function confirmJoin() {
            const name = document.getElementById('player-name').value.trim();
            if (!name) return alert('è¯·è¾“å…¥æ˜µç§°');
            
            document.getElementById('player-name-display').innerText = name;
            document.getElementById('join-overlay').style.display = 'none';
            document.getElementById('waiting-msg').style.display = 'block';

            // è¿æ¥ MQTT
            window.gameClient.connect(() => {
                document.getElementById('status-text').innerText = 'âœ… å·²è¿æ¥';
                document.getElementById('status-text').style.color = '#2ecc71';
                console.log('Player connected, publishing JOIN to:', TOPIC_JOIN);
                window.gameClient.subscribe(TOPIC_CMD);
                
                // å»¶æ—¶ä¸€ç‚¹ç¡®ä¿è®¢é˜…æˆåŠŸ
                setTimeout(() => {
                    resendJoin(); // ä½¿ç”¨å°è£…çš„å‡½æ•°å‘é€
                }, 500);
            });
            
             // ç›‘å¬æ–­çº¿
            if (window.gameClient.client) {
                window.gameClient.client.on('offline', () => {
                    document.getElementById('status-text').innerText = 'âŒ å·²æ–­å¼€';
                    document.getElementById('status-text').style.color = 'red';
                });
                window.gameClient.client.on('reconnect', () => {
                    document.getElementById('status-text').innerText = 'ğŸ”„ é‡è¿ä¸­...';
                });
            }
        }
        
        function resendJoin() {
            const name = document.getElementById('player-name').value.trim();
            if(name) {
                // ä½¿ç”¨ QoS 1 ç¡®ä¿é€è¾¾ (mqtt.jsé»˜è®¤QoS 0ï¼Œä½†åœ¨ä¸å¯é ç½‘ç»œä¸‹æœ€å¥½ç”¨1ï¼Œä¸è¿‡wsé€šå¸¸å¯é )
                // è¿™é‡Œæˆ‘ä»¬ç®€å•å¤šæ¬¡å‘é€æˆ–è€…æ‰‹åŠ¨å‘é€å³å¯
                window.gameClient.publish(TOPIC_JOIN, 'JOIN', { name: name });
                
                // ç®€å•çš„è§†è§‰åé¦ˆ
                const btn = document.querySelector('button[onclick="resendJoin()"]');
                if(btn) {
                    const originalText = btn.innerText;
                    btn.innerText = 'å·²å‘é€!';
                    setTimeout(() => btn.innerText = originalText, 2000);
                }
            }
        }

        // ç›‘å¬æŒ‡ä»¤
        window.gameClient.on('REPORT_STATUS', () => {
            console.log('Host requested status report');
            const name = document.getElementById('player-name').value.trim();
            if (name) {
                window.gameClient.publish(TOPIC_JOIN, 'REPORT_ACK', { name: name });
            }
        });

        window.gameClient.on('DEAL', (payload) => {
            console.log('Received DEAL', payload);
            const myId = window.gameClient.client.options.clientId; // è·å–å½“å‰ clientId
            
            // åœ¨ payload.hands ä¸­æŸ¥æ‰¾è‡ªå·±çš„ç‰Œ
            // æ³¨æ„ï¼šå› ä¸º mqtt clientId åœ¨æ¯æ¬¡ connect æ—¶å¦‚æœæ˜¯éšæœºç”Ÿæˆçš„ï¼Œéœ€è¦ä¿æŒä¸€è‡´
            // åœ¨ mqtt-client.js ä¸­æˆ‘ä»¬ç”Ÿæˆäº†ä¸€æ¬¡éšæœº IDï¼Œåªè¦ä¸åˆ·æ–°é¡µé¢å°±æ˜¯ç¨³å®šçš„
            // ä½†å¦‚æœæˆ¿ä¸»ç”¨çš„ ID æ˜¯ sender å­—æ®µï¼Œæˆ‘ä»¬éœ€è¦åŒ¹é… sender
            
            // ä¿®æ­£é€»è¾‘ï¼šDEAL æ¶ˆæ¯é‡Œçš„ key æ˜¯ clientId
            // æˆ‘ä»¬éœ€è¦çŸ¥é“è‡ªå·±çš„ clientIdã€‚mqtt.js client.options.clientId å¯èƒ½è·å–ä¸åˆ°ï¼Œ
            // ä½†æˆ‘ä»¬åœ¨ publish JOIN æ—¶å‘é€äº† senderã€‚
            // å®é™…ä¸Š mqtt-client.js é‡Œå‘é€æ¶ˆæ¯æ—¶è‡ªåŠ¨åŠ äº† sender å­—æ®µç­‰äº BASE_CLIENT_ID
            
            const myCards = payload.hands[window.MQTT_CLIENT_ID];
            
            if (myCards) {
                myHand = myCards;
                renderHand();
                document.getElementById('waiting-msg').style.display = 'none';
                document.getElementById('hand-area').style.display = 'block';
            }
        });

        window.gameClient.on('BALL_POCKETED', (payload) => {
            const { ball, value } = payload;
            markBallPocketed(ball, value);
        });

        window.gameClient.on('RESET', () => {
            myHand = [];
            document.getElementById('hand-area').style.display = 'none';
            document.getElementById('waiting-msg').style.display = 'block';
        });

        function renderHand() {
            const container = document.getElementById('cards-container');
            container.innerHTML = myHand.map(card => {
                let color = 'black';
                if (['H', 'D'].includes(card.suit)) color = '#e74c3c';
                if (card.suit === 'J' && card.value === 'Big') color = '#e74c3c';
                
                let suitIcon = '';
                if (card.suit === 'S') suitIcon = 'â™ ';
                if (card.suit === 'H') suitIcon = 'â™¥';
                if (card.suit === 'C') suitIcon = 'â™£';
                if (card.suit === 'D') suitIcon = 'â™¦';
                if (card.suit === 'J') suitIcon = 'ğŸƒ';
                
                return `
                <div class="hand-card" id="card-${card.id}" style="color: ${color}">
                    <div style="font-size: 0.8rem;">${suitIcon}</div>
                    <div style="font-size: 1.2rem; font-weight: bold;">${card.value}</div>
                </div>
            `}).join('');
        }

        function markBallPocketed(id, value) {
            // é€»è¾‘å‡çº§ï¼šåªè¦ value ç›¸åŒï¼Œå°±éƒ½æ‰“å‰
            // éå†æˆ‘çš„æ‰‹ç‰Œï¼Œæ‰¾åˆ°æ‰€æœ‰ value ç›¸åŒçš„ç‰Œ
            
            // å¦‚æœ payload æ²¡æœ‰å¸¦ value (å…¼å®¹æ—§ç‰ˆæˆ–ç›´æ¥ ID åŒ¹é…)ï¼Œå…ˆå°è¯• ID åŒ¹é…
            const targetCard = document.getElementById(`card-${id}`);
            if (targetCard) targetCard.classList.add('pocketed');

            // å¦‚æœæœ‰ valueï¼Œåˆ™åŒ¹é…åŒæ•°å€¼çš„æ‰€æœ‰ç‰Œ
            if (value) {
                myHand.forEach(card => {
                    if (card.value === value) {
                         const c = document.getElementById(`card-${card.id}`);
                         if (c) c.classList.add('pocketed');
                    }
                });
            }

            if (navigator.vibrate) navigator.vibrate(200);
        }
    </script>
</body>
</html>